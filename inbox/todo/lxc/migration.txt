Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.4
Creation-Date: 2017-01-16T17:59:09+01:00

====== migration ======
Created Monday 16 January 2017

===== Procedure =====
To @move / @migrate @lxc $containers between host systems.

1. Shutdown the container: //user@system:~$// **lxc-stop -n $NAME**
2. Archive container rootfs & config:
	a. //user@system:~$// **cd /var/lib/lxc/$NAME/**
	b. //user@system:~$// **tar --numeric-owner -czvf <container_fs>.tar.gz ./*** 
	
	Note: The '//--numeric-owner//' flag is very important! Without it, the container may not boot because the uid/gids get mangled in the extracted filesystem. 
	 When tar creates an archive with that flag raised, it preserves user / group ownership information. By default, when extracting, tar tries to resolve the archive user/group ownership names with the ids on the system running tar. This is intended to ensure that user ownership is resolved on the new system, in case the UID numeric values differ between systems. This is bad for an LXC filesystem because the numeric uid/gid ownership is intended to be preserved for the whole filesystem. If it gets resolved to a different value, bad things happen.
	
3. Copy the file to your new server: //user@system:~$// **rsync -avh <container_fs>.tar.gz user@newserver:/var/lib/lxc/**
4. Extract rootfs:
	a. //user@system:~$// **mkdir /var/lib/lxc/$NAME/**
	b. //user@system:~$// **cd /var/lib/lxc/$NAME/**
	c. //user@system:~$// **tar --numeric-owner -xzvf <container_fs>.tar.gz ./***

===== Notes =====
If you're using an overlay backed container, you'll also need to migrate the container this new one is based off of. Lastly, you might see a few warnings about skipped socket files: `//tar: /var/lib/lxc/$NAME/rootfs/dev/log: socket ignored//` I've ignored this error, and haven't had any issues with any of the containers I manage.

==== References ====
* Original: http://stackoverflow.com/questions/23427129/how-do-i-backup-move-lxc-containers/34194341#34194341
